<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>SzczegÃ³Å‚y rezerwacji - AWON</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>SzczegÃ³Å‚y rezerwacji</h1>
    <form id="bookingForm">
      <input type="hidden" id="booking_id">

      <label for="guest_name">ImiÄ™ i nazwisko:</label>
      <input type="text" id="guest_name">

      <label for="guest_phone">Telefon:</label>
      <input type="text" id="guest_phone">

      <label for="guest_email">E-mail:</label>
      <input type="email" id="guest_email">

      <label for="start_date">Data przyjazdu:</label>
      <input type="date" id="start_date">

      <label for="end_date">Data wyjazdu:</label>
      <input type="date" id="end_date">

      <label for="adults">DoroÅ›li:</label>
      <input type="number" id="adults" min="1">

      <label for="children">Dzieci:</label>
      <input type="number" id="children" min="0">

      <label for="pets">ZwierzÄ™ta:</label>
      <input type="checkbox" id="pets">

      <label for="total_price">Cena caÅ‚kowita:</label>
      <input type="number" id="total_price" step="0.01">

      <label for="deposit">Zadatek:</label>
      <input type="number" id="deposit" step="0.01">

      <label for="due_date">Termin dopÅ‚aty:</label>
      <input type="date" id="due_date">

      <label for="notes">Notatki:</label>
      <textarea id="notes"></textarea>

      <label>
        <input type="checkbox" id="cleaning_task"> Zadanie sprzÄ…tania
      </label>

      <label>
        <input type="checkbox" id="safe_reminder"> Powiadomienie o sejfie
      </label>

      <div class="form-buttons">
        <button type="submit" class="btn-primary">ðŸ’¾ Zapisz zmiany</button>
        <button type="button" class="btn-danger" id="deleteBtn">ðŸ—‘ UsuÅ„ rezerwacjÄ™</button>
      </div>
    </form>
  </div>

  <script>
    const API_URL = "http://localhost:3000"; // zmieÅ„ na swÃ³j backend
    const token = localStorage.getItem("token");

    if (!token) {
      alert("Musisz byÄ‡ zalogowany!");
      window.location.href = "login.html";
    }

    const urlParams = new URLSearchParams(window.location.search);
    const bookingId = urlParams.get("id");

    if (!bookingId) {
      alert("Brak ID rezerwacji");
      window.location.href = "bookings.html";
    }

    async function loadBooking() {
      const res = await fetch(`${API_URL}/bookings/${bookingId}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const b = await res.json();

      document.getElementById("booking_id").value = b.id;
      document.getElementById("guest_name").value = b.guest_name || "";
      document.getElementById("guest_phone").value = b.guest_phone || "";
      document.getElementById("guest_email").value = b.guest_email || "";
      document.getElementById("start_date").value = b.start_date || "";
      document.getElementById("end_date").value = b.end_date || "";
      document.getElementById("adults").value = b.adults || 1;
      document.getElementById("children").value = b.children || 0;
      document.getElementById("pets").checked = b.pets || false;
      document.getElementById("total_price").value = b.total_price || 0;
      document.getElementById("deposit").value = b.deposit || 0;
      document.getElementById("due_date").value = b.due_date || "";
      document.getElementById("notes").value = b.notes || "";
      document.getElementById("cleaning_task").checked = b.cleaning_task || false;
      document.getElementById("safe_reminder").checked = b.safe_reminder || false;
    }

    document.getElementById("bookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const booking = {
        guest_name: document.getElementById("guest_name").value,
        guest_phone: document.getElementById("guest_phone").value,
        guest_email: document.getElementById("guest_email").value,
        start_date: document.getElementById("start_date").value,
        end_date: document.getElementById("end_date").value,
        adults: parseInt(document.getElementById("adults").value),
        children: parseInt(document.getElementById("children").value),
        pets: document.getElementById("pets").checked,
        total_price: parseFloat(document.getElementById("total_price").value) || 0,
        deposit: parseFloat(document.getElementById("deposit").value) || 0,
        due_date: document.getElementById("due_date").value || null,
        notes: document.getElementById("notes").value,
        cleaning_task: document.getElementById("cleaning_task").checked,
        safe_reminder: document.getElementById("safe_reminder").checked
      };

      const res = await fetch(`${API_URL}/bookings/${bookingId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(booking)
      });

      if (res.ok) {
        alert("Zapisano zmiany!");
        window.location.href = "bookings.html";
      } else {
        const err = await res.json();
        alert("BÅ‚Ä…d: " + err.error);
      }
    });

    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (!confirm("Na pewno usunÄ…Ä‡ rezerwacjÄ™?")) return;

      const res = await fetch(`${API_URL}/bookings/${bookingId}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
      });

      if (res.ok) {
        alert("Rezerwacja usuniÄ™ta!");
        window.location.href = "bookings.html";
      } else {
        const err = await res.json();
        alert("BÅ‚Ä…d: " + err.error);
      }
    });

    loadBooking();
  </script>
</body>
</html>
