<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dodaj rezerwację - AWON</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Dodaj rezerwację</h1>

    <form id="addBookingForm">
      <!-- Wybór obiektu -->
      <label for="property_id">Obiekt:</label>
      <select id="property_id" required></select>

      <!-- Wybór pokoju -->
      <label for="room_id">Pokój:</label>
      <select id="room_id" required></select>

      <!-- Dane klienta -->
      <label for="guest_name">Imię i nazwisko:</label>
      <input type="text" id="guest_name" required>

      <label for="guest_phone">Telefon:</label>
      <input type="text" id="guest_phone">

      <label for="guest_email">E-mail:</label>
      <input type="email" id="guest_email">

      <!-- Daty -->
      <label for="start_date">Data przyjazdu:</label>
      <input type="date" id="start_date" required>

      <label for="end_date">Data wyjazdu:</label>
      <input type="date" id="end_date" required>

      <!-- Szczegóły pobytu -->
      <label for="adults">Dorośli:</label>
      <input type="number" id="adults" value="1" min="1">

      <label for="children">Dzieci:</label>
      <input type="number" id="children" value="0" min="0">

      <label for="pets">Zwierzęta:</label>
      <input type="checkbox" id="pets">

      <!-- Finanse -->
      <label for="total_price">Cena całkowita:</label>
      <input type="number" id="total_price" step="0.01">

      <label for="deposit">Zadatek:</label>
      <input type="number" id="deposit" step="0.01">

      <label for="due_date">Termin dopłaty:</label>
      <input type="date" id="due_date">

      <!-- Notatki -->
      <label for="notes">Notatki:</label>
      <textarea id="notes"></textarea>

      <!-- Parafki -->
      <label>
        <input type="checkbox" id="cleaning_task"> Wyślij informację o sprzątaniu
      </label>
      <label>
        <input type="checkbox" id="safe_reminder"> Powiadomić klienta o odbiorze kluczy z sejfu
      </label>

      <button type="submit" class="btn-primary">Zapisz rezerwację</button>
    </form>
  </div>

  <script>
    const API_URL = "http://localhost:3000"; // zmień na swój backend (np. vercel)

    const token = localStorage.getItem("token");
    if (!token) {
      alert("Musisz być zalogowany!");
      window.location.href = "login.html";
    }

    // Pobierz obiekty
    async function loadProperties() {
      const res = await fetch(`${API_URL}/properties`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const properties = await res.json();
      const select = document.getElementById("property_id");
      properties.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });
      if (properties.length === 1) {
        select.value = properties[0].id;
        loadRooms(properties[0].id);
      }
    }

    // Pobierz pokoje dla wybranego obiektu
    async function loadRooms(propertyId) {
      const res = await fetch(`${API_URL}/rooms?property_id=${propertyId}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const rooms = await res.json();
      const select = document.getElementById("room_id");
      select.innerHTML = "";
      rooms.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.name;
        select.appendChild(opt);
      });
    }

    document.getElementById("property_id").addEventListener("change", (e) => {
      loadRooms(e.target.value);
    });

    // Obsługa formularza
    document.getElementById("addBookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const booking = {
        room_id: document.getElementById("room_id").value,
        guest_name: document.getElementById("guest_name").value,
        guest_phone: document.getElementById("guest_phone").value,
        guest_email: document.getElementById("guest_email").value,
        start_date: document.getElementById("start_date").value,
        end_date: document.getElementById("end_date").value,
        adults: parseInt(document.getElementById("adults").value),
        children: parseInt(document.getElementById("children").value),
        pets: document.getElementById("pets").checked,
        total_price: parseFloat(document.getElementById("total_price").value) || 0,
        deposit: parseFloat(document.getElementById("deposit").value) || 0,
        due_date: document.getElementById("due_date").value || null,
        notes: document.getElementById("notes").value,
        cleaning_task: document.getElementById("cleaning_task").checked,
        safe_reminder: document.getElementById("safe_reminder").checked
      };

      const res = await fetch(`${API_URL}/bookings`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(booking)
      });

      if (res.ok) {
        alert("Rezerwacja dodana!");
        window.location.href = "bookings.html";
      } else {
        const err = await res.json();
        alert("Błąd: " + err.error);
      }
    });

    loadProperties();
  </script>
</body>
</html>
