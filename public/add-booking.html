<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dodaj rezerwacjÄ™</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>âž• Dodaj rezerwacjÄ™</h1>

  <form id="addBookingForm" class="form">
    <label>Obiekt:
      <select id="propertySelect" class="input" required></select>
    </label>

    <label>PokÃ³j:
      <select id="roomSelect" class="input" required></select>
    </label>

    <label>Data poczÄ…tkowa:
      <input type="date" id="startDate" class="input" required>
    </label>

    <label>Data koÅ„cowa:
      <input type="date" id="endDate" class="input" required>
    </label>

    <h3>Dane klienta</h3>
    <label>ImiÄ™ i nazwisko:
      <input type="text" id="guestName" class="input" required>
    </label>
    <label>Telefon:
      <input type="text" id="guestPhone" class="input">
    </label>
    <label>Email:
      <input type="email" id="guestEmail" class="input">
    </label>

    <h3>SzczegÃ³Å‚y pobytu</h3>
    <label>DoroÅ›li:
      <input type="number" id="adults" class="input" value="1" min="1">
    </label>
    <label>Dzieci:
      <input type="number" id="children" class="input" value="0" min="0">
    </label>
    <label>
      <input type="checkbox" id="pets"> ZwierzÄ™ta
    </label>

    <h3>PÅ‚atnoÅ›ci</h3>
    <label>Cena caÅ‚kowita:
      <input type="number" id="totalPrice" class="input" step="0.01">
    </label>
    <label>Zadatek:
      <input type="number" id="deposit" class="input" step="0.01" oninput="updateRemaining()">
    </label>
    <label>Termin dopÅ‚aty:
      <input type="date" id="dueDate" class="input">
    </label>
    <label>DopÅ‚ata (automatyczna):
      <input type="number" id="remainingAmount" class="input" readonly>
    </label>

    <h3>Inne</h3>
    <label>Notatki:
      <textarea id="notes" class="input"></textarea>
    </label>
    <label>
      <input type="checkbox" id="cleaningTask"> SprzÄ…tanie
    </label>
    <label>
      <input type="checkbox" id="safeReminder"> Sejf z kluczami
    </label>

    <div class="actions">
      <button type="submit" class="btn btn-primary">ðŸ’¾ Zapisz</button>
      <button type="button" class="btn btn-secondary" onclick="window.location.href='bookings.html'">â¬… PowrÃ³t</button>
    </div>
  </form>

  <script>
    const API_PROPERTIES = "/properties";
    const API_ROOMS = "/rooms";
    const API_BOOKINGS = "/bookings";
    const token = localStorage.getItem("token");

    async function loadProperties() {
      const res = await fetch(API_PROPERTIES, {
        headers: { "Authorization": "Bearer " + token }
      });
      const properties = await res.json();
      const select = document.getElementById("propertySelect");

      if (properties.length === 0) {
        alert("Najpierw dodaj obiekt.");
        window.location.href = "add-property.html";
        return;
      }

      select.innerHTML = "";
      properties.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });

      if (properties.length === 1) {
        select.value = properties[0].id;
        loadRooms(properties[0].id);
      }
    }

    async function loadRooms(propertyId) {
      const res = await fetch(`${API_ROOMS}?property_id=${propertyId}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const rooms = await res.json();
      const select = document.getElementById("roomSelect");
      select.innerHTML = "";

      rooms.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.name;
        select.appendChild(opt);
      });

      if (rooms.length === 1) {
        select.value = rooms[0].id;
      }
    }

    document.getElementById("propertySelect").addEventListener("change", e => {
      loadRooms(e.target.value);
    });

    function updateRemaining() {
      const total = parseFloat(document.getElementById("totalPrice").value) || 0;
      const deposit = parseFloat(document.getElementById("deposit").value) || 0;
      document.getElementById("remainingAmount").value = Math.max(total - deposit, 0).toFixed(2);
    }

    document.getElementById("addBookingForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        room_id: document.getElementById("roomSelect").value,
        start_date: document.getElementById("startDate").value,
        end_date: document.getElementById("endDate").value,
        guest_name: document.getElementById("guestName").value,
        guest_phone: document.getElementById("guestPhone").value,
        guest_email: document.getElementById("guestEmail").value,
        adults: parseInt(document.getElementById("adults").value),
        children: parseInt(document.getElementById("children").value),
        pets: document.getElementById("pets").checked,
        total_price: parseFloat(document.getElementById("totalPrice").value),
        deposit: parseFloat(document.getElementById("deposit").value),
        due_date: document.getElementById("dueDate").value,
        notes: document.getElementById("notes").value,
        cleaning_task: document.getElementById("cleaningTask").checked,
        safe_reminder: document.getElementById("safeReminder").checked
      };

      const res = await fetch(API_BOOKINGS, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });

      if (res.ok) {
        alert("Rezerwacja dodana");
        window.location.href = "bookings.html";
      } else {
        const err = await res.json();
        alert("BÅ‚Ä…d: " + (err.error || "Nie udaÅ‚o siÄ™ dodaÄ‡ rezerwacji"));
      }
    });

    loadProperties();
  </script>
</body>
</html>
