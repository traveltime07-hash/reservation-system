<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Panel administratora - AWON</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <h1>Panel administratora</h1>

    <!-- Wyszukiwanie u≈ºytkownik√≥w -->
    <div class="search-bar">
      <input type="text" id="searchEmail" placeholder="Szukaj po e-mailu">
      <button onclick="searchUsers()" class="btn-secondary">üîç Szukaj</button>
    </div>

    <!-- Tabela u≈ºytkownik√≥w -->
    <h2>Lista u≈ºytkownik√≥w</h2>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Rola</th>
          <th>Data rejestracji</th>
          <th>Ostatnie logowanie</th>
          <th>Status</th>
          <th>Subskrypcja</th>
          <th>Opcje</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Statystyki -->
    <h2>Statystyki</h2>
    <div id="stats">
      <p><strong>Aktywne konta:</strong> <span id="activeUsers">0</span></p>
      <p><strong>Nieaktywne konta:</strong> <span id="inactiveUsers">0</span></p>
      <p><strong>Liczba rezerwacji:</strong> <span id="totalBookings">0</span></p>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:3000"; // zmie≈Ñ na backend (np. vercel)
    const token = localStorage.getItem("token");

    if (!token) {
      alert("Musisz byƒá zalogowany!");
      window.location.href = "login.html";
    }

    // Pobierz listƒô u≈ºytkownik√≥w
    async function loadUsers(query = "") {
      const res = await fetch(`${API_URL}/admin/users?search=${query}`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const users = await res.json();
      const tbody = document.querySelector("#usersTable tbody");
      tbody.innerHTML = "";

      users.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${u.email}</td>
          <td>${u.role}</td>
          <td>${u.created_at || "-"}</td>
          <td>${u.last_login || "-"}</td>
          <td>${u.is_active ? "‚úÖ aktywne" : "‚ùå zablokowane"}</td>
          <td>${u.subscription_status || "darmowe"} (do ${u.subscription_expires || "-"})</td>
          <td>
            <button onclick="resetPassword('${u.id}')" class="btn-secondary">üîë Reset has≈Ça</button>
            <button onclick="setNewPassword('${u.id}')" class="btn-secondary">‚úèÔ∏è Nadaj has≈Ço</button>
            <button onclick="editSubscription('${u.id}')" class="btn-secondary">üí≥ Subskrypcja</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Pobierz statystyki
    async function loadStats() {
      const res = await fetch(`${API_URL}/admin/stats`, {
        headers: { "Authorization": "Bearer " + token }
      });
      const stats = await res.json();
      document.getElementById("activeUsers").textContent = stats.active_users;
      document.getElementById("inactiveUsers").textContent = stats.inactive_users;
      document.getElementById("totalBookings").textContent = stats.total_bookings;
    }

    // Funkcje akcji admina
    async function resetPassword(userId) {
      if (!confirm("Wys≈Çaƒá link resetujƒÖcy do u≈ºytkownika?")) return;
      const res = await fetch(`${API_URL}/admin/users/${userId}/reset-password`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token }
      });
      alert(res.ok ? "Wys≈Çano link resetujƒÖcy" : "B≈ÇƒÖd resetu has≈Ça");
    }

    async function setNewPassword(userId) {
      const newPass = prompt("Podaj nowe has≈Ço dla u≈ºytkownika:");
      if (!newPass) return;
      const res = await fetch(`${API_URL}/admin/users/${userId}/set-password`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ password: newPass })
      });
      alert(res.ok ? "Has≈Ço ustawione" : "B≈ÇƒÖd ustawiania has≈Ça");
    }

    async function editSubscription(userId) {
      const newDate = prompt("Podaj nowƒÖ datƒô wa≈ºno≈õci subskrypcji (YYYY-MM-DD):");
      if (!newDate) return;
      const res = await fetch(`${API_URL}/admin/users/${userId}/subscription`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ subscription_expires: newDate })
      });
      alert(res.ok ? "Subskrypcja zaktualizowana" : "B≈ÇƒÖd aktualizacji subskrypcji");
      loadUsers();
    }

    function searchUsers() {
      const email = document.getElementById("searchEmail").value;
      loadUsers(email);
    }

    // Za≈Çaduj dane na start
    loadUsers();
    loadStats();
  </script>
</body>
</html>
